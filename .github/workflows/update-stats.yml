name: Update Portfolio Stats

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight
  workflow_dispatch: # Allows manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write # explicit permission to push changes
    steps:
      # 1. Checkout YOUR Portfolio Repo (The missing step!)
      - name: Checkout Portfolio
        uses: actions/checkout@v3

      # 2. Checkout the TARGET Repo (Kornia) to a temporary folder
      - name: Checkout Kornia Repo
        uses: actions/checkout@v3
        with:
          repository: kornia/kornia-rs
          path: temp-kornia
          fetch-depth: 0 # Important: Fetch all history for accurate line counts

      - name: Calculate Stats
        id: stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MY_GIT_NAME: "Dhruv Jain"
          MY_GH_USER: "dhruvkjain"
          TARGET_REPO: "kornia/kornia-rs"
        run: |
          # 1. Count Merged PRs
          PR_COUNT=$(gh search prs --repo "$TARGET_REPO" --author "$MY_GH_USER" --json url --jq length --limit 1000 "is:merged")
          
          # 2. Count Lines Added (Go into the temp folder first!)
          cd temp-kornia
          LOC_COUNT=$(git log --author="$MY_GIT_NAME" --pretty=tformat: --numstat | awk '{ add += $1 } END { printf "%s", add }')
          cd ..
          
          # 3. Save to output
          echo "PR_COUNT=$PR_COUNT" >> $GITHUB_ENV
          echo "LOC_COUNT=$LOC_COUNT" >> $GITHUB_ENV

      - name: Update README
        run: |
          # Replace the number following the specific text
          sed -i "s/\(Total PRs in kornia-rs: \)[0-9]*/\1$PR_COUNT/" README.md
          
          # Same for Lines of Code
          sed -i "s/\(Lines of Code in kornia-rs: \)[0-9]*/\1$LOC_COUNT/" README.md

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -am "Update kornia stats" && git push)
