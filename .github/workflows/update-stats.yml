name: Update Portfolio Stats

on:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight
  workflow_dispatch: # Allows manual trigger

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          repository: kornia/kornia-rs
          path: temp-kornia
          fetch-depth: 0 # Important: Fetch all history for accurate line counts

      - name: Calculate Stats
        id: stats
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MY_GIT_NAME: "Dhruv Jain"
          MY_GH_USER: "dhruvkjain"
          TARGET_REPO: "kornia/kornia-rs"
        run: |
          # 1. Count Merged PRs (Targeting specific repo)
          PR_COUNT=$(gh search prs --repo "$TARGET_REPO" --author "$MY_GH_USER" --state merged --json url --jq length)
          
          # 2. Count Lines Added (Go into the temp folder first!)
          cd temp-kornia
          LOC_COUNT=$(git log --author="$MY_GIT_NAME" --pretty=tformat: --numstat | awk '{ add += $1 } END { printf "%s", add }')
          cd ..
          
          # 3. Save to output
          echo "PR_COUNT=$PR_COUNT" >> $GITHUB_ENV
          echo "LOC_COUNT=$LOC_COUNT" >> $GITHUB_ENV

      - name: Update README
        run: |
          # This updates the README in the root of your Portfolio repo
          sed -i "s/.*/$PR_COUNT/" README.md
          sed -i "s/.*/$LOC_COUNT/" README.md

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -am "Update kornia stats" && git push)
